"use strict";var GitItemType,BannerStyle;!function(e){e.Page="page",e.Module="module",e.Config="config",e.Other="other"}(GitItemType||(GitItemType={})),function(e){e[e.info=0]="info",e[e.notice=1]="notice",e[e.error=2]="error"}(BannerStyle||(BannerStyle={}));class PushyAdmin{constructor(){this.changedItems=[],this.initEventHandlers()}initEventHandlers(){document.getElementById("publish").addEventListener("click",(e=>{e.preventDefault();const t=this.getSelectedItems();t&&this.publishItems(t)}));const e=document.getElementById("select-all");e.addEventListener("click",(()=>{const t=document.getElementsByClassName("selectbox");for(const n of t)n.checked=e.checked;this.enablePublishButton()}));document.getElementById("summary").addEventListener("input",(()=>{this.enablePublishButton()}))}getSelectedItems(){const e={items:[],message:""},t=document.getElementById("summary"),n=document.getElementById("summary-alert");if(!t.value)return t.classList.add("invalid"),void n.classList.add("invalid");t.classList.remove("invalid"),n.classList.remove("invalid"),e.message=t.value;const s=document.getElementsByClassName("selectbox");for(let t=0;t<s.length;t++)s[t].checked&&e.items.push(this.changedItems[t]);return e}async fetchItems(){try{const e=await fetch(window.location.pathname+"/pushy:readItems",{method:"POST"});if(!e.ok)return void this.setBannerText(pushy.translations.fetchInvalidResponse,BannerStyle.error);this.changedItems=await e.json()}catch(e){return void this.setBannerText(pushy.translations.fetchException,BannerStyle.error)}if(this.changedItems){const e=pushy.translations.fetchItemsFound.replace("{count}",this.changedItems.length.toString());this.setBannerText(e,BannerStyle.info),this.updateMenuBadge(),this.displayItems()}}clearInputs(){const e=document.querySelectorAll("input, textarea");for(const t of e)t.value="",t.checked=!1}updateMenuBadge(){const e=document.querySelectorAll("#admin-menu li"),t=e[Array.from(e).findIndex((e=>{var t;return(null===(t=e.querySelector("em"))||void 0===t?void 0:t.innerHTML)==pushy.translations.menuLabel}))].querySelector("#admin-menu li a .badge.count");if(t){const e=Object.keys(this.changedItems).length;t.innerHTML=e>0?e.toString():""}}displayItems(){this.clearInputs();const e=document.createElement("body");for(let t=0;t<this.changedItems.length;t++){const n=this.changedItems[t];let s="",a="",i="";switch(n.index){case"A":a=pushy.translations.statusNew,i=n.title;break;case"M":a=pushy.translations.statusModified,i=n.title;break;case"D":a=pushy.translations.statusDeleted,i=n.path;break;case"R":a=pushy.translations.statusRenamed,i=`${n.orig_path} <i class="fa fa-long-arrow-right"></i> ${n.path}`;break;default:throw new Error(`Invalid status "${n.index}"`)}s=`\n                <td class="select">\n                    <input class="selectbox" type="checkbox">\n                </td>\n                <td class="status">\n                    ${a}\n                </td>\n                `,n.type==GitItemType.Page?"D"==n.index?s+=`<td class="path">${i}</td>`:s+=`\n                        <td class="path">\n                            <a href="${n.siteUrl}" target="_blank">\n                                ${i}\n                                <i class="fa fa-external-link"></i>\n                            </a>\n                        </td>\n                        `:n.type==GitItemType.Module?s+=n.title:n.type==GitItemType.Config?s+=n.path:n.type==GitItemType.Other&&n.siteUrl?s+=`\n                    <a href="${n.siteUrl}" target="_blank">\n                        ${n.path}\n                        <i class="fa fa-external-link"></i>\n                    </a>\n                    `:s+=n.path,n.adminUrl&&(s+=`\n                    <td class="edit">\n                        <a href="${n.adminUrl}"><i class="fa fa-fw fa-pencil"></i></a>\n                    </td>\n                    `);const l=document.createElement("tr");l.innerHTML=s,e.appendChild(l)}document.getElementById("itemlist").innerHTML=e.innerHTML;const t=document.getElementsByClassName("selectbox");for(const e of t)e.addEventListener("click",(()=>{this.enablePublishButton()}))}async publishItems(e){let t;this.clearBannerText();try{t=await fetch(window.location.pathname+"/pushy:publishItems",{method:"POST",body:JSON.stringify(e)})}catch(e){return void this.setBannerText(pushy.translations.publishException,BannerStyle.error)}if(t.ok){const e=await t.json();e.isSuccess?this.setBannerText(e.alert,BannerStyle.info):this.setBannerText(e.alert,BannerStyle.error),this.fetchItems()}else this.setBannerText(pushy.translations.publishInvalidResponse,BannerStyle.error)}setBannerText(e,t){const n=document.createElement("div");n.className=`${BannerStyle[t]} alert publish`;const s=document.createTextNode(e);n.appendChild(s);const a=document.getElementById("messages");null==a||a.appendChild(n)}clearBannerText(){const e=document.getElementsByClassName("alert publish"),t=document.getElementById("messages");for(const n of e)null==t||t.removeChild(n)}enablePublishButton(){const e=document.getElementById("summary"),t=document.querySelectorAll(".selectbox:checked").length>0,n=document.getElementById("publish");e.value&&t?n.classList.add("enabled"):n.classList.remove("enabled")}}const admin=new PushyAdmin;admin.fetchItems();